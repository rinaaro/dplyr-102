---
title: "Financial data analysis"
author: "Arina Agaronyan"
format: 
  html: 
    echo: false 
---

```{r config}
#| message: false
here::i_am("dplyr-102.Rproj")
library(here)
library(vroom) ## or readr
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_bw())
```

## Data loading

```{r load_data}
#| message: false
clients <- vroom(here("data", "client.csv")) ## split file name into directories, then file name
accounts <- vroom(here("data", "account.csv"))
disp <- vroom(here("data", "disp.csv"))
```


## Joining data tables
A collection of joining functions of the form '*_join'.

### Inner join

```{r da}
da <- inner_join(accounts, disp) ## merges data using the one same variable (account_id here)
```

```{r cda}
cda <- inner_join(clients, da, by = join_by(client_id), suffix = c("_home", "_bank")) 
#join - look for common vars and join on those vars, but here leads to removal of some values (~10%) which have mismatching values for a var (due to moving...- don't live where the bank is) so have to add specification of joinby
#by = join by makes two vers of other common var - district_id.x/y - can rename
```


### Home district vs Bank district

```{r home_diff}
home_diff_bank <- cda |>
  filter(district_id_home != district_id_bank) |> ## != not equal to
  nrow()
```
We observe that `r home_diff_bank` clients have a bank in another district than the one they live in.

(May be overestimation due to families, so check clients who share account but don't live together)
```{r filter_home_diff}
cda |> 
  group_by(account_id) |>
  distinct(district_id_home) |>
  summarise(N=n()) |>
  filter(N>1)
```
(nevermind)


### Gender gap?

```{r countG}
clients |> count(gender)
```

```{r}
clients |>
  ggplot(aes(y=gender)) +
  geom_bar() ## if long vaues on geom_bar, better on y axis. can originally put x= then + coord_flip()
```

Acount distribution
```{r}
cda |>
  count(gender, type) |>
  group_by(gender)|>
  mutate(freq=n/sum(n))|>
  select(-n) |> 
  ungroup() |>
  pivot_wider(values_from = freq, names_from = type)
```

```{r}
cda |>
  ggplot(aes(y=gender, fill=type)) +
  geom_bar(position = "fill")
```

```{r}
chisq.test(cda |> pull(gender), 
           cda |> pull(type))
```
p-value=0.5, can't reject null hypothesis of independence
